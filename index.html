<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECrew - Absensi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #f8fafc; /* slate-50 */
        }
        .bg-hero-pattern {
            background-color: #ffffff;
            background-image: radial-gradient(#e2e8f0 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .fade-in { animation: fadeIn 0.6s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card-hover { 
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }
        input[type="file"] { display: none; }
        .custom-file-upload {
            border: 1px solid #cbd5e1;
            display: inline-block;
            padding: 8px 12px;
            cursor: pointer;
            background-color: #fff;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease;
        }
        .custom-file-upload:hover {
            background-color: #f1f5f9;
        }
        .btn-primary {
            @apply w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-300 transform hover:scale-105;
        }
        .btn-secondary {
             @apply w-full bg-slate-200 text-slate-800 font-semibold p-2 rounded-md hover:bg-slate-300 transition-colors duration-200;
        }
        .input-field {
            @apply w-full pl-10 pr-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition;
        }
        .select-field {
            @apply w-full p-2.5 border border-slate-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 bg-white;
        }
    </style>
</head>
<body class="text-slate-800">

    <div id="app" class="min-h-screen flex items-center justify-center bg-hero-pattern p-4">

        <!-- Login Page -->
        <div id="login-page" class="w-full max-w-md fade-in">
            <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-2xl p-8 border border-slate-200">
                <div class="text-center mb-8">
                    <h1 class="text-4xl font-extrabold text-slate-900 tracking-tight">ECrew</h1>
                    <p class="text-slate-500 mt-2">Portal Absensi Karyawan Transwisata</p>
                </div>
                <form id="login-form">
                    <div class="space-y-6">
                        <div>
                            <label for="email" class="block text-sm font-medium text-slate-700 mb-1">Email</label>
                            <div class="relative"><span class="absolute inset-y-0 left-0 flex items-center pl-3"><i data-lucide="mail" class="h-5 w-5 text-slate-400"></i></span><input type="email" id="email" name="email" placeholder="Email Anda" class="input-field" required></div>
                        </div>
                        <div>
                            <label for="password" class="block text-sm font-medium text-slate-700 mb-1">Password</label>
                             <div class="relative"><span class="absolute inset-y-0 left-0 flex items-center pl-3"><i data-lucide="lock" class="h-5 w-5 text-slate-400"></i></span><input type="password" id="password" name="password" placeholder="Password (Nama Depan Anda)" class="input-field" required></div>
                        </div>
                    </div>
                    <div id="error-message" class="text-red-500 text-sm mt-4 text-center hidden"></div>
                    <button type="submit" class="btn-primary mt-8">Log In</button>
                </form>
                 <p class="text-center text-xs text-slate-400 mt-8">&copy; 2024 Transwisata. All rights reserved.</p>
            </div>
        </div>

        <!-- Dashboard Page -->
        <div id="dashboard-page" class="w-full max-w-6xl hidden fade-in">
            <div class="bg-white rounded-2xl shadow-2xl border border-slate-200">
                <header class="p-6 md:p-8 border-b border-slate-200 flex flex-col md:flex-row justify-between items-start md:items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-slate-900">Dashboard</h1>
                        <p id="welcome-message" class="text-slate-500 mt-1">Memuat data...</p>
                    </div>
                    <button id="logout-button" class="mt-4 md:mt-0 flex items-center gap-2 bg-slate-100 text-slate-600 font-semibold py-2 px-4 rounded-lg hover:bg-slate-200 transition"><i data-lucide="log-out" class="h-4 w-4"></i><span>Logout</span></button>
                </header>

                <div class="p-6 md:p-8">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
                        <div id="absen-card" class="card-hover bg-gradient-to-br from-indigo-500 to-blue-500 text-white p-6 rounded-xl cursor-pointer flex flex-col justify-between"><div class="flex items-center gap-4"><div class="bg-white/20 p-3 rounded-lg"><i data-lucide="fingerprint" class="h-6 w-6"></i></div><h2 class="text-xl font-bold">Absensi Hari Ini</h2></div><p class="mt-2 text-indigo-100 text-sm">Catat kehadiran, laporkan pekerjaan, dan lihat ringkasan hari Anda.</p></div>
                        <div id="riwayat-card" class="card-hover bg-white border border-slate-200 p-6 rounded-xl cursor-pointer flex flex-col justify-between"><div class="flex items-center gap-4"><div class="bg-slate-100 text-slate-600 p-3 rounded-lg"><i data-lucide="history" class="h-6 w-6"></i></div><h2 class="text-xl font-bold text-slate-800">Riwayat Absen</h2></div><p class="mt-2 text-slate-500 text-sm">Lihat kembali catatan kehadiran dan laporan kerja Anda sebelumnya.</p></div>
                        <div id="news-card" class="card-hover bg-white border border-slate-200 p-6 rounded-xl cursor-pointer flex flex-col justify-between"><div class="flex items-center gap-4"><div class="bg-slate-100 text-slate-600 p-3 rounded-lg"><i data-lucide="newspaper" class="h-6 w-6"></i></div><h2 class="text-xl font-bold text-slate-800">Update News</h2></div><p class="mt-2 text-slate-500 text-sm">Informasi dan pengumuman terbaru dari perusahaan.</p></div>
                    </div>

                    <div id="content-area" class="bg-slate-50 p-6 rounded-lg min-h-[300px] border border-slate-200">
                        <!-- Dynamic content will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Modal -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50 backdrop-blur-sm"><div id="modal-content" class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center fade-in"><div id="modal-icon" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4"><i data-lucide="check" class="h-6 w-6 text-green-600"></i></div><h3 id="modal-title" class="text-lg font-medium text-gray-900">Berhasil!</h3><p id="modal-message" class="text-sm text-gray-500 mt-2">Aksi Anda telah berhasil diproses.</p><button id="modal-close" class="mt-6 w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700">Tutup</button></div></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();

        // --- Elements ---
        const loginPage = document.getElementById('login-page');
        const dashboardPage = document.getElementById('dashboard-page');
        const loginForm = document.getElementById('login-form');
        const errorMessage = document.getElementById('error-message');
        const welcomeMessage = document.getElementById('welcome-message');
        const logoutButton = document.getElementById('logout-button');
        const contentArea = document.getElementById('content-area');

        // --- New User Database ---
        const users = {
            'managementtranswisata@gmail.com': { password: 'rustam', name: 'Rustam Suhanda', division: 'Staf', position: 'President Director', role: 'ADMIN' },
            'warauw_1@yahoo.com': { password: 'selfy', name: 'Selfy Warauw', division: 'Staf', position: 'Director', role: 'ADMIN' },
            'crunkbolcow@gmail.com': { password: 'muhamad', name: 'Muhamad Ramdani Masri', division: 'Operation', position: 'Chief Pilot Rotary Wing', role: 'ADMIN' },
            'fly5103@gmail.com': { password: 'sulaksono', name: 'Sulaksono Teddy Prabowo', division: 'Operation', position: 'Line Pilot', role: 'USER' },
            'marcelino412ep@gmail.com': { password: 'marcelino', name: 'Marcelino Bhaharoenawanto', division: 'Operation', position: 'Line Pilot', role: 'USER' },
            'sofwanm819@gmail.com': { password: 'muhamad', name: 'Muhamad Sofwan', division: 'Operation', position: 'Chief Pilot Fixed Wing', role: 'ADMIN' },
            'sofiantobing692@gmail.com': { password: 'sofian', name: 'Sofian M. L. Tobing', division: 'Operation', position: 'General Manager', role: 'USER' },
            'ricofebdi@gmail.com': { password: 'rico', name: 'Rico Febdiandana', division: 'Operation', position: 'Chief Flight Support', role: 'USER' },
            'alfajri_koto@yahoo.com': { password: 'alfajri', name: 'Alfajri', division: 'Operation', position: 'Line Pilot', role: 'USER' },
            'tioxpilot@gmail.com': { password: 'eli', name: 'Eli Setya', division: 'Operation', position: 'Line Pilot', role: 'USER' },
            'harijantosusetyo@gmail.com': { password: 'susetyo', name: 'Susetyo Harijanto', division: 'Operation', position: 'Operation Manager', role: 'ADMIN' },
            'purwoko.mulyono@yahoo.com': { password: 'purwoko', name: 'Purwoko', division: 'Operation', position: 'Line Pilot', role: 'USER' },
            'icul2122@gmail.com': { password: 'riza', name: 'Riza Hanindita', division: 'Operation', position: 'Line Pilot', role: 'USER' },
            'henaldy.ts204@gmail.com': { password: 'henaldy', name: 'Henaldy Arifia Sudrajat', division: 'Operation', position: 'Line Pilot', role: 'USER' },
            'amelberliana@yahoo.co.id': { password: 'kadek', name: 'Kadek Amelia Nadya Berliana', division: 'Operation', position: 'Line Pilot', role: 'USER' },
            'qnatawijaya@gmail.com': { password: 'qorry', name: 'Qorry Maulidya Natawijaya', division: 'Operation', position: 'Cabin Service', role: 'USER' },
            'anggiashentira@gmail.com': { password: 'shentira', name: 'Shentira Anggia Putri', division: 'Operation', position: 'Cabin Service', role: 'USER' },
            'tiffanipriciliaaaa@gmail.com': { password: 'tiffani', name: 'Tiffani Pricilia Hasan', division: 'Operation', position: 'Cabin Service', role: 'USER' },
            'agustinzulfani74@gmail.com': { password: 'agustin', name: 'Agustin Zulfani Prihatini', division: 'Operation', position: 'Cabin Service', role: 'USER' },
            'ivankacasey99@gmail.com': { password: 'nadya', name: 'Nadya Casey Ivanka', division: 'Operation', position: 'Cabin Service', role: 'USER' },
            'prihatnoyanu@gmail.com': { password: 'yanu', name: 'Yanu Prihatno', division: 'Maintenance', position: 'Engineer', role: 'USER' },
            'bayu.avicena@gmail.com': { password: 'bayu', name: 'Bayu Nugroho', division: 'Maintenance', position: 'Engineer', role: 'USER' },
            'nawawahyudisuseno090@gmail.com': { password: 'wahyudi', name: 'Wahyudi Suseno', division: 'Maintenance', position: 'Avionic', role: 'USER' },
            'sigithardadi88@yahoo.com': { password: 'sigit', name: 'Sigit Hardadi', division: 'Maintenance', position: 'Engineer', role: 'USER' },
            'hadikamilatun@gmail.com': { password: 'hadi', name: 'Hadi Sutrisno', division: 'Maintenance', position: 'Maintenance Manager', role: 'USER' },
            'suhairitwa@gmail.com': { password: 'suhairi', name: 'Suhairi', division: 'Maintenance', position: 'Engineer', role: 'USER' },
            'yanto.umardin@gmail.com': { password: 'suyanto', name: 'Suyanto', division: 'Maintenance', position: 'Avionic', role: 'USER' },
            'rioraymond89@gmail.com': { password: 'lazarus', name: 'Lazarus Rio Raymond', division: 'Maintenance', position: 'Engineer', role: 'USER' },
            'mpiipie@gmail.com': { password: 'febie', name: 'Febie Aguti Effendi', division: 'Maintenance', position: 'Engineer', role: 'USER' },
            'dikiatnu7@gmail.com': { password: 'diki', name: 'Diki Hariyanto', division: 'Maintenance', position: 'Chief Engineer', role: 'USER' },
            'prayitsusonggo@yahoo.com': { password: 'prayit', name: 'Prayit Susonggo', division: 'Maintenance', position: 'Avionic', role: 'USER' },
            'iskandarakbarhakim@gmail.com': { password: 'iskandar', name: 'Iskandar Akbar Hakim', division: 'Maintenance', position: 'Chief Inspector', role: 'USER' },
            'glexxrsvpcgo@outlook.com': { password: 'arif', name: 'Arif Vrybadi Halim', division: 'Maintenance', position: 'Engineer', role: 'USER' },
            'alfizaekap@gmail.com': { password: 'alfiza', name: 'Alfiza Eka Putra', division: 'Maintenance', position: 'Engineer', role: 'USER' },
            'deditren99@gmail.com': { password: 'dedi', name: 'Dedi Prasetyo', division: 'Safety', position: 'Aviation Security', role: 'USER' },
            'mediamarbun@gmail.com': { password: 'media', name: 'Media H Marbun', division: 'Staf', position: 'Human Resource Development', role: 'ADMIN' },
            'ulieumeda@gmail.com': { password: 'fatmawati', name: 'Fatmawati', division: 'Staf', position: 'Finance', role: 'USER' },
            'd2rahman@yahoo.co.id': { password: 'dede', name: 'Dede Rahman Arafiq', division: 'Staf', position: 'Finance', role: 'USER' },
            'leosinay@gmail.com': { password: 'leo', name: 'Leo Fitzgerald Sinay', division: 'Maintenance', position: 'Chief Engineering', role: 'USER' },
            'pohan16zaman@gmail.com': { password: 'khairul', name: 'Khairul Zaman Pohan', division: 'Operation', position: 'Flight Support', role: 'USER' },
            'sentotbasuki@gmail.com': { password: 'sentot', name: 'Sentot Basuki', division: 'Operation', position: 'Flight Support', role: 'USER' },
            'bobby.feisal22@gmail.com': { password: 'bobby', name: 'Bobby Feisal Mahardhika', division: 'Staf', position: 'Engineering', role: 'USER' },
            'tri3wiwid@gmail.com': { password: 'tri', name: 'Tri Widayat', division: 'Operation', position: 'Flight Support', role: 'USER' },
            'is.darminto35@gmail.com': { password: 'isdarminto', name: 'Isdarminto', division: 'Staf', position: 'Logistic', role: 'USER' },
            'sulaichann@gmail.com': { password: 'sulaichan', name: 'Sulaichan Noor Ali', division: 'Staf', position: 'Logistic', role: 'USER' },
            'sbayuputro@gmail.com': { password: 'sri', name: 'Sri Muljono Bayu Putro', division: 'Operation', position: 'Flight Support', role: 'USER' },
            'asrigatot.67@gmail.com': { password: 'asri', name: 'Asri Gatot Yulianto', division: 'Safety', position: 'Aviation Security', role: 'USER' },
            'nanangchabibi3@gmail.com': { password: 'nanang', name: 'Nanang Chabibi', division: 'Safety', position: 'Aviation Security', role: 'USER' },
            'katellisna423@gmail.com': { password: 'hariyanto', name: 'Hariyanto', division: 'Safety', position: 'Aviation Security', role: 'USER' },
            'fardhan0509@gmail.com': { password: 'supriyono', name: 'Supriyono', division: 'Staf', position: 'Kurir', role: 'USER' },
            'kasna.pjln799@gmail.com': { password: 'kasna', name: 'Kasna', division: 'Staf', position: 'Driver', role: 'USER' },
            'rizalsetiawan020812@gmail.com': { password: 'rizal', name: 'Rizal Setiawan', division: 'Staf', position: 'Driver', role: 'USER' },
            'ardi.rizk91@gmail.com': { password: 'ardi', name: 'Ardi Rizki', division: 'Maintenance', position: 'Engineer', role: 'USER' },
            'setiawanwawan7312@gmail.com': { password: 'wawan', name: 'Wawan Setiawan', division: 'Operation', position: 'Line Pilot', role: 'USER' },
            'tommysaputra473@gmail.com': { password: 'tommy', name: 'Tommy Saputra', division: 'Staf', position: 'Chief Finance, Accounting & Tax', role: 'USER' },
            'mch_riza@yahoo.com': { password: 'mochamad', name: 'Mochamad Riza', division: 'Safety', position: 'Quality, Safety, Security Manager', role: 'USER' },
            'alexanderdevata@yahoo.co.id': { password: 'alexander', name: 'Alexander Anggarda Yunan Devata', division: 'Operation', position: 'Flight Support', role: 'USER' },
            'sskkyy020@gmail.com': { password: 'sukyono', name: 'Sukyono', division: 'Operation', position: 'Flight Support', role: 'USER' }
        };
        
        // --- Dropdown Options ---
        const workTypeOptions = [ "Office Hour", "Standby Flight", "Standby on Call", "Pos One Gate", "Day Off", "Day Off 7 Consecutive Days for Pilot", "Flight Duty VIP", "Ferry Flight", "PPC Simulator", "PPC Aircraft", "Test Flight", "Ground Run", "Recurrent Training", "Recency Flight", "Meeting Out of Office", "Medical Examination", "Annual Leave", "Sick", "Technical Representative", "Aviation Security", "Over Time" ];
        const dutyAsOptions = [ "Director", "Safety, Quality & Security Manager", "Operation Manager", "Maintenance Manager", "Chief Pilot Fixed Wing", "Chief Pilot Rotary Wing", "Chief Flight Support", "Chief Inspector", "Chief Engineer", "Chief Finance, Accounting & Staf", "Chief Engineering", "Pilot in Command", "Second in Command", "Ground Instructor", "Flight Instructor", "Company Check Pilot", "Engineer", "Line Pilot", "Cabin Service", "Student", "Flight Support", "Ground Support", "Technical Representative", "Engineering", "Staff", "Logistic", "Aviation Security", "Driver" ];

        let currentUser = null;
        // --- State for Attendance ---
        let attendanceState = {
            clockInTime: null,
            clockOutTime: null,
            photoIn: null,
            locationIn: null,
            locationOut: null,
            workReportPhoto: null
        };
        let cameraStream = null;

        // --- Functions ---
        const showPage = (page) => {
            loginPage.classList.add('hidden');
            dashboardPage.classList.add('hidden');
            page.classList.remove('hidden');
        };

        const showModal = (title, message, isSuccess = true) => {
            const modal = document.getElementById('modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            const iconContainer = document.getElementById('modal-icon');
            iconContainer.innerHTML = isSuccess ? '<i data-lucide="check" class="h-6 w-6 text-green-600"></i>' : '<i data-lucide="x-circle" class="h-6 w-6 text-red-600"></i>';
            iconContainer.className = `mx-auto flex items-center justify-center h-12 w-12 rounded-full mb-4 ${isSuccess ? 'bg-green-100' : 'bg-red-100'}`;
            lucide.createIcons();
            modal.classList.remove('hidden');
        };
        const hideModal = () => document.getElementById('modal').classList.add('hidden');

        const handleLogin = (e) => {
            e.preventDefault();
            const email = loginForm.email.value.trim().toLowerCase();
            const password = loginForm.password.value;
            errorMessage.classList.add('hidden');
            
            const user = users[email];
            
            if (user && user.password === password.toLowerCase()) {
                currentUser = user;
                welcomeMessage.textContent = `Selamat datang kembali, ${user.name}!`;
                showPage(dashboardPage);
                updateContent('welcome');
            } else {
                errorMessage.textContent = 'Email atau password salah.';
                errorMessage.classList.remove('hidden');
            }
        };

        const handleLogout = () => {
            stopCamera();
            currentUser = null;
            attendanceState = { clockInTime: null, clockOutTime: null, photoIn: null, locationIn: null, locationOut: null, workReportPhoto: null };
            loginForm.reset();
            showPage(loginPage);
        };

        const formatTime = (date) => date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        const formatDate = (date) => date.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

        const startCamera = async () => {
            const video = document.getElementById('camera-preview');
            const startBtn = document.getElementById('start-camera-btn');
            const captureBtn = document.getElementById('capture-photo-btn');
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                try {
                    cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                    video.srcObject = cameraStream;
                    video.classList.remove('hidden');
                    startBtn.classList.add('hidden');
                    captureBtn.classList.remove('hidden');
                } catch (error) {
                    showModal('Error Kamera', 'Tidak dapat mengakses kamera. Pastikan Anda memberikan izin.', false);
                }
            }
        };

        const stopCamera = () => {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
        };

        const capturePhoto = () => {
            const video = document.getElementById('camera-preview');
            const canvas = document.getElementById('photo-canvas');
            const capturedImage = document.getElementById('captured-image');
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            attendanceState.photoIn = canvas.toDataURL('image/png');
            capturedImage.src = attendanceState.photoIn;
            capturedImage.classList.remove('hidden');
            video.classList.add('hidden');
            document.getElementById('capture-photo-btn').classList.add('hidden');
            stopCamera();
        };

        const getLocation = (elementId) => {
            const el = document.getElementById(elementId);
            if (navigator.geolocation) {
                el.innerHTML = '<div class="flex items-center gap-2"><div class="animate-spin h-4 w-4 border-2 border-slate-400 border-t-transparent rounded-full"></div><span>Mencari lokasi...</span></div>';
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        const location = { lat: latitude, lon: longitude };
                        if (elementId.includes('in')) attendanceState.locationIn = location;
                        else attendanceState.locationOut = location;
                        el.innerHTML = `Lat: ${latitude.toFixed(5)}, Lon: ${longitude.toFixed(5)} <i data-lucide="check-circle" class="inline-block h-4 w-4 text-green-500"></i>`;
                        lucide.createIcons();
                    },
                    () => {
                        el.innerHTML = 'Gagal mendapatkan lokasi. <i data-lucide="alert-triangle" class="inline-block h-4 w-4 text-red-500"></i>';
                        lucide.createIcons();
                        showModal('Error Lokasi', 'Tidak dapat mengakses lokasi. Pastikan GPS dan izin lokasi aktif.', false);
                    }
                );
            } else {
                el.textContent = 'Geolocation tidak didukung.';
            }
        };

        const handleClockIn = () => {
            if (!attendanceState.photoIn) {
                showModal('Validasi Gagal', 'Harap ambil foto selfie terlebih dahulu.', false);
                return;
            }
            if (!attendanceState.locationIn) {
                showModal('Validasi Gagal', 'Harap dapatkan lokasi Anda terlebih dahulu.', false);
                return;
            }

            attendanceState.clockInTime = new Date();
            showModal('Absen Masuk Berhasil', `Terima kasih, ${currentUser.name}. Kehadiran Anda telah dicatat.`);
            updateContent('absen');
        };

        const handleClockOut = () => {
            const remark = document.getElementById('remark').value;
            if (!remark.trim()) {
                 showModal('Validasi Gagal', 'Harap isi remark pekerjaan hari ini.', false);
                return;
            }
             if (!attendanceState.workReportPhoto) {
                showModal('Validasi Gagal', 'Harap unggah foto pekerjaan hari ini.', false);
                return;
            }
            if (!attendanceState.locationOut) {
                showModal('Validasi Gagal', 'Harap dapatkan lokasi pulang Anda terlebih dahulu.', false);
                return;
            }

            attendanceState.clockOutTime = new Date();
            showModal('Absen Pulang Berhasil', 'Absen pulang Anda telah berhasil dicatat. Selamat beristirahat!');
            updateContent('absen');
        };
        
        const updateContent = (menu) => {
            stopCamera(); // Stop camera whenever content changes
            let contentHTML = '';
            switch (menu) {
                case 'absen':
                    const now = new Date();
                    const clockInTime = attendanceState.clockInTime;
                    const clockOutTime = attendanceState.clockOutTime;

                    let clockInStatus = '', clockInStatusColor = '', lateReasonHTML = '';
                    if (clockInTime) {
                        const clockInHour = clockInTime.getHours();
                        const clockInMinute = clockInTime.getMinutes();
                        if (clockInHour < 9 || (clockInHour === 9 && clockInMinute === 0)) {
                            clockInStatus = 'Tepat Waktu';
                            clockInStatusColor = 'text-green-600';
                        } else {
                            clockInStatus = 'Terlambat';
                            clockInStatusColor = 'text-red-600';
                            lateReasonHTML = `<div class="mt-4"><label for="late_reason" class="block text-sm font-medium text-slate-700">Alasan Terlambat</label><textarea id="late_reason" rows="2" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Jelaskan alasan keterlambatan Anda"></textarea></div>`;
                        }
                    }
                    
                    let clockOutStatus = '', clockOutStatusColor = '', overtimeHTML = '', totalWorkTimeHTML = '';
                    if (clockOutTime) {
                         const clockOutHour = clockOutTime.getHours();
                         const clockOutMinute = clockOutTime.getMinutes();
                         if (clockOutHour < 17) {
                            clockOutStatus = 'Pulang Sebelum Waktunya';
                            clockOutStatusColor = 'text-yellow-600';
                         } else if (clockOutHour === 17 && clockOutMinute <= 30) {
                            clockOutStatus = 'Pulang Tepat Waktu';
                            clockOutStatusColor = 'text-green-600';
                         } else {
                            clockOutStatus = 'Waktu Kerja Melebihi';
                            clockOutStatusColor = 'text-blue-600';
                            
                            const overtimeStart = new Date(clockOutTime);
                            overtimeStart.setHours(17, 30, 0, 0);
                            const diffMs = clockOutTime - overtimeStart;
                            if(diffMs > 0){
                                const diffHrs = Math.floor(diffMs / 3600000);
                                const diffMins = Math.floor((diffMs % 3600000) / 60000);
                                const diffSecs = Math.floor(((diffMs % 3600000) % 60000) / 1000);
                                overtimeHTML = `<p class="text-sm"><strong>Total Overtime:</strong> ${diffHrs}j ${diffMins}m ${diffSecs}d</p>`;
                            }
                         }

                         const workDiffMs = clockOutTime - clockInTime;
                         const workHrs = Math.floor(workDiffMs / 3600000);
                         const workMins = Math.floor((workDiffMs % 3600000) / 60000);
                         const workSecs = Math.floor(((workDiffMs % 3600000) % 60000) / 1000);
                         totalWorkTimeHTML = `<p class="text-sm mt-2"><strong>Total Jam Kerja:</strong> ${workHrs}j ${workMins}m ${workSecs}d</p>`;
                    }
                    
                    const dutyOptionsHTML = dutyAsOptions.map(opt => `<option value="${opt}">${opt}</option>`).join('');
                    const workTypeOptionsHTML = workTypeOptions.map(opt => `<option value="${opt}">${opt}</option>`).join('');

                    const userInfoHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 text-sm bg-slate-100 p-4 rounded-lg mb-6 border border-slate-200">
                            <p><strong>Nama:</strong> <span class="text-slate-600">${currentUser.name}</span></p>
                            <p><strong>Email:</strong> <span class="text-slate-600">${currentUser.email}</span></p>
                            <p><strong>Divisi:</strong> <span class="text-slate-600">${currentUser.division}</span></p>
                            <p><strong>Posisi:</strong> <span class="text-slate-600">${currentUser.position}</span></p>
                            <div>
                                <label for="duty-as" class="block font-bold mb-1 text-slate-800">Duty As</label>
                                <select id="duty-as" class="select-field">${dutyOptionsHTML}</select>
                            </div>
                            <div>
                                <label for="type-of-work" class="block font-bold mb-1 text-slate-800">Type of Work</label>
                                <select id="type-of-work" class="select-field">${workTypeOptionsHTML}</select>
                            </div>
                        </div>`;

                    const clockInHTML = `
                        <div id="clock-in-section" class="${clockInTime ? 'hidden' : ''}">
                            <h3 class="font-bold text-lg mb-4 border-b pb-2 flex items-center gap-2"><i data-lucide="log-in" class="h-5 w-5 text-indigo-500"></i>Absen Masuk</h3>
                            <div class="grid md:grid-cols-2 gap-6">
                                <div>
                                    <p class="font-semibold text-slate-700">1. Foto Masuk (Selfie)</p>
                                    <div class="mt-2 p-2 border-2 border-dashed rounded-lg text-center bg-white">
                                        <video id="camera-preview" class="w-full rounded-md hidden" autoplay playsinline></video>
                                        <canvas id="photo-canvas" class="hidden"></canvas>
                                        <img id="captured-image" class="w-full rounded-md hidden" alt="Captured Photo">
                                        <button id="start-camera-btn" class="btn-secondary">Buka Kamera</button>
                                        <button id="capture-photo-btn" class="w-full bg-indigo-500 text-white p-2 rounded-md hover:bg-indigo-600 hidden mt-2">Ambil Foto</button>
                                    </div>
                                </div>
                                <div class="space-y-4">
                                    <div>
                                        <p class="font-semibold text-slate-700">2. Lokasi Masuk</p>
                                        <div id="location-in" class="mt-2 p-3 bg-white rounded-md border text-slate-600">Lokasi belum diambil</div>
                                        <button id="get-location-in-btn" class="btn-secondary mt-2">Dapatkan Lokasi</button>
                                    </div>
                                    <div>
                                        <p class="font-semibold text-slate-700">3. Tanggal & Waktu</p>
                                        <p class="mt-2 p-3 bg-white rounded-md border">${formatDate(now)} - ${formatTime(now)}</p>
                                    </div>
                                </div>
                            </div>
                            <button id="clock-in-btn" class="w-full mt-8 bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition flex items-center justify-center gap-2"><span>KIRIM ABSEN MASUK</span><i data-lucide="arrow-right"></i></button>
                        </div>`;

                    const clockOutHTML = `
                        <div id="clock-out-section" class="${!clockInTime || clockOutTime ? 'hidden' : ''}">
                             <h3 class="font-bold text-lg mb-4 border-b pb-2 flex items-center gap-2"><i data-lucide="log-out" class="h-5 w-5 text-red-500"></i>Absen Pulang</h3>
                             <div class="bg-green-50 border-l-4 border-green-500 text-green-800 p-4 rounded-md mb-6" role="alert">
                                <p class="font-bold flex items-center gap-2"><i data-lucide="check-circle"></i>Absen Masuk Tercatat</p>
                                <p class="pl-7">Pada ${clockInTime ? formatDate(clockInTime) + ' pukul ' + formatTime(clockInTime) : ''} (<span class="font-semibold ${clockInStatusColor}">${clockInStatus}</span>)</p>
                             </div>
                             ${lateReasonHTML}
                            <div class="grid md:grid-cols-2 gap-6 mt-4">
                                <div>
                                    <label class="font-semibold block mb-2 text-slate-700">1. Remark Pekerjaan Hari Ini</label>
                                    <textarea id="remark" rows="5" class="w-full rounded-md border-slate-300 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Jelaskan pekerjaan yang telah Anda selesaikan hari ini..."></textarea>
                                </div>
                                <div>
                                    <label class="font-semibold block mb-2 text-slate-700">2. Foto Laporan Pekerjaan</label>
                                    <label for="work-photo-upload" class="custom-file-upload w-full text-center hover:bg-slate-100">
                                        <i data-lucide="upload" class="inline-block h-4 w-4"></i> Pilih File dari Galeri
                                    </label>
                                    <input id="work-photo-upload" type="file" accept="image/*"/>
                                    <img id="work-photo-preview" class="mt-2 w-full rounded-md hidden max-h-36 object-cover border p-1 bg-white" alt="Work Photo Preview">
                                </div>
                            </div>
                             <div class="mt-4">
                                <p class="font-semibold text-slate-700">3. Lokasi Pulang</p>
                                <div id="location-out" class="mt-2 p-3 bg-white rounded-md border text-slate-600">Lokasi belum diambil</div>
                                <button id="get-location-out-btn" class="btn-secondary mt-2">Dapatkan Lokasi</button>
                             </div>
                             <button id="clock-out-btn" class="w-full mt-8 bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 transition flex items-center justify-center gap-2"><span>KIRIM ABSEN PULANG</span><i data-lucide="arrow-right"></i></button>
                        </div>`;
                    
                    const summaryHTML = `
                        <div id="summary-section" class="${!clockOutTime ? 'hidden' : ''}">
                             <h3 class="font-bold text-lg mb-4 border-b pb-2 flex items-center gap-2"><i data-lucide="file-check-2" class="h-5 w-5 text-blue-500"></i>Ringkasan Absensi Hari Ini</h3>
                             <div class="bg-slate-100 border border-slate-200 p-4 rounded-lg space-y-2" role="alert">
                                <p class="font-bold text-slate-800">Absensi hari ini telah selesai.</p>
                                <p class="text-sm"><strong>Masuk:</strong> ${clockInTime ? formatTime(clockInTime) : ''} <span class="font-semibold ${clockInStatusColor}">(${clockInStatus})</span></p>
                                <p class="text-sm"><strong>Pulang:</strong> ${clockOutTime ? formatTime(clockOutTime) : ''} <span class="font-semibold ${clockOutStatusColor}">(${clockOutStatus})</span></p>
                                ${totalWorkTimeHTML}
                                ${overtimeHTML}
                             </div>
                        </div>`;

                    contentHTML = `
                        <div class="flex justify-between items-center mb-6">
                             <h2 class="text-2xl font-bold">Formulir Absensi</h2>
                             <p class="text-sm text-slate-500">Status: <span class="font-semibold py-1 px-2 rounded-full ${clockInTime && !clockOutTime ? 'bg-green-100 text-green-700': (clockOutTime ? 'bg-blue-100 text-blue-700' : 'bg-slate-200 text-slate-700')}">${clockInTime && !clockOutTime ? 'On Working' : (clockOutTime ? 'Selesai Bekerja' : 'Belum Absen')}</span></p>
                        </div>
                        ${userInfoHTML}
                        ${clockInHTML}
                        ${clockOutHTML}
                        ${summaryHTML}
                    `;
                    break;
                case 'riwayat': contentHTML = `<h3 class="font-bold text-lg">Riwayat Absensi</h3><p>Fitur riwayat absensi akan segera tersedia.</p>`; break;
                case 'news': contentHTML = `<h3 class="font-bold text-lg">Update News</h3><p>Belum ada berita atau pengumuman terbaru.</p>`; break;
                default: contentHTML = `<div class="text-center py-10"><h3 class="font-bold text-2xl text-slate-700">Selamat Datang di ECrew!</h3><p class="text-slate-500 mt-2">Pilih salah satu menu di atas untuk memulai aktivitas Anda.</p></div>`;
            }
            contentArea.innerHTML = contentHTML;
            lucide.createIcons();
            // Add event listeners for new dynamic elements
            if (menu === 'absen') {
                if (!attendanceState.clockInTime) {
                    document.getElementById('start-camera-btn')?.addEventListener('click', startCamera);
                    document.getElementById('capture-photo-btn')?.addEventListener('click', capturePhoto);
                    document.getElementById('get-location-in-btn')?.addEventListener('click', () => getLocation('location-in'));
                    document.getElementById('clock-in-btn')?.addEventListener('click', handleClockIn);
                }
                if (attendanceState.clockInTime && !attendanceState.clockOutTime) {
                    document.getElementById('get-location-out-btn')?.addEventListener('click', () => getLocation('location-out'));
                    document.getElementById('clock-out-btn')?.addEventListener('click', handleClockOut);
                    document.getElementById('work-photo-upload')?.addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                attendanceState.workReportPhoto = event.target.result;
                                const preview = document.getElementById('work-photo-preview');
                                preview.src = attendanceState.workReportPhoto;
                                preview.classList.remove('hidden');
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                }
            }
        };

        // --- Event Listeners ---
        loginForm.addEventListener('submit', handleLogin);
        logoutButton.addEventListener('click', handleLogout);
        document.getElementById('absen-card').addEventListener('click', () => updateContent('absen'));
        document.getElementById('riwayat-card').addEventListener('click', () => updateContent('riwayat'));
        document.getElementById('news-card').addEventListener('click', () => updateContent('news'));
        document.getElementById('modal-close').addEventListener('click', hideModal);
        document.getElementById('modal').addEventListener('click', (e) => { if(e.target.id === 'modal') hideModal(); });

        showPage(loginPage);
    });
    </script>
</body>
</html>
