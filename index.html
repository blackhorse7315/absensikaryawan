<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Absensi Karyawan - PT. Transwisata Prima Aviation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .form-input, .form-select {
            @apply w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200;
        }
        .btn {
            @apply w-full px-4 py-3 text-white font-semibold rounded-lg shadow-md transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2;
        }
        .btn-primary {
            @apply bg-blue-600 hover:bg-blue-700 focus:ring-blue-500;
        }
        .btn-secondary {
            @apply bg-green-600 hover:bg-green-700 focus:ring-green-500;
        }
        .btn-danger {
            @apply bg-red-600 hover:bg-red-700 focus:ring-red-500;
        }
        .btn-disabled {
            @apply bg-gray-400 cursor-not-allowed;
        }
        .card {
            @apply bg-white p-6 sm:p-8 rounded-xl shadow-lg;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-2xl mx-auto">
        <div class="card">
            <div class="text-center mb-8">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Absensi Karyawan</h1>
                <p class="text-gray-500">PT. Transwisata Prima Aviation</p>
            </div>

            <!-- Form Data Diri -->
            <div id="form-data-diri" class="space-y-4">
                <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">1. Data Diri & Pekerjaan</h2>
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-600 mb-1">Nama Lengkap</label>
                    <input type="text" id="name" name="name" class="form-input" placeholder="Masukkan nama Anda">
                </div>
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-600 mb-1">Email Valid</label>
                    <input type="email" id="email" name="email" class="form-input" placeholder="contoh@email.com">
                </div>
                <div>
                    <label for="division" class="block text-sm font-medium text-gray-600 mb-1">Divisi</label>
                    <input type="text" id="division" name="division" class="form-input" placeholder="e.g., Operasional">
                </div>
                <div>
                    <label for="position" class="block text-sm font-medium text-gray-600 mb-1">Jabatan</label>
                    <input type="text" id="position" name="position" class="form-input" placeholder="e.g., Staff">
                </div>
                 <div>
                    <label for="duty_as" class="block text-sm font-medium text-gray-600 mb-1">Duty As</label>
                    <input type="text" id="duty_as" name="duty_as" class="form-input" placeholder="e.g., Pilot">
                </div>
                <div>
                    <label for="work_type" class="block text-sm font-medium text-gray-600 mb-1">Tipe Pekerjaan</label>
                    <select id="work_type" name="work_type" class="form-select">
                        <option>Work From Office (WFO)</option>
                        <option>Work From Home (WFH)</option>
                        <option>Hybrid</option>
                    </select>
                </div>
            </div>

            <!-- Absen Masuk -->
            <div id="form-absen-masuk" class="mt-8 space-y-4">
                <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">2. Absensi Masuk</h2>
                
                <!-- Kamera -->
                <div class="p-4 border rounded-lg bg-gray-50">
                    <h3 class="font-semibold text-gray-600 mb-2">Ambil Foto Wajah</h3>
                    <video id="video" class="w-full h-auto rounded-lg bg-black" autoplay playsinline></video>
                    <canvas id="canvas" class="hidden w-full h-auto rounded-lg"></canvas>
                    <button id="capture-btn" class="btn btn-primary mt-3">Ambil Foto</button>
                </div>

                <button id="absen-masuk-btn" class="btn btn-secondary !mt-6 btn-disabled" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" /></svg>
                    Absen Masuk
                </button>

                <div id="status-masuk-container" class="hidden p-4 border-l-4 rounded-r-lg">
                    <p id="status-masuk-text" class="font-semibold"></p>
                    <div id="alasan-terlambat-container" class="hidden mt-3">
                        <label for="alasan_terlambat" class="block text-sm font-medium text-gray-600 mb-1">Alasan Terlambat</label>
                        <textarea id="alasan_terlambat" name="alasan_terlambat" rows="3" class="form-input" placeholder="Jelaskan alasan keterlambatan Anda"></textarea>
                    </div>
                </div>
            </div>

            <!-- Absen Pulang -->
            <div id="form-absen-pulang" class="hidden mt-8 space-y-4">
                <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">3. Absensi Pulang</h2>
                
                <div>
                    <label for="remark" class="block text-sm font-medium text-gray-600 mb-1">Remark Pekerjaan Hari Ini</label>
                    <textarea id="remark" name="remark" rows="4" class="form-input" placeholder="Tuliskan ringkasan pekerjaan Anda hari ini"></textarea>
                </div>
                
                <div>
                    <label for="foto_pekerjaan" class="block text-sm font-medium text-gray-600 mb-1">Foto Pekerjaan Hari Ini (Opsional)</label>
                    <input type="file" id="foto_pekerjaan" name="foto_pekerjaan" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                </div>

                <button id="absen-pulang-btn" class="btn btn-danger !mt-6">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                    Absen Pulang
                </button>

                <div id="status-pulang-container" class="hidden p-4 border-l-4 rounded-r-lg">
                    <p id="status-pulang-text" class="font-semibold"></p>
                    <p id="total-worktime-text" class="mt-2 text-sm"></p>
                    <p id="total-overtime-text" class="mt-1 text-sm font-semibold"></p>
                </div>
            </div>

            <!-- Kirim Laporan -->
            <div id="form-kirim" class="hidden mt-8">
                 <button id="kirim-laporan-btn" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
                    Kirim Laporan Absensi
                 </button>
            </div>
            
            <div id="loading-spinner" class="hidden text-center mt-4">
                <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <p class="mt-2 text-gray-600">Mengirim data...</p>
            </div>
            <div id="success-message" class="hidden mt-6 p-4 bg-green-100 border-l-4 border-green-500 text-green-700 rounded-r-lg">
                <p class="font-bold">Berhasil!</p>
                <p>Laporan absensi Anda telah berhasil dikirim.</p>
            </div>
             <div id="error-message" class="hidden mt-6 p-4 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-r-lg">
                <p class="font-bold">Gagal!</p>
                <p>Terjadi kesalahan saat mengirim data. Pastikan URL Google Script valid dan coba lagi.</p>
            </div>
        </div>
    </div>

<script>
// =================================================================================
// PENTING: Ganti URL di bawah ini dengan URL Web App dari Google Apps Script Anda
// =================================================================================
const googleScriptURL = 'https://script.google.com/macros/s/AKfycbwgQzaadG3MyL9ZT58Mwy0sY2m7MA6PjDJ2xEPrBwN2M3FaZH5W2JSflt1qPMJlzSgl/exec'; // <-- PASTE URL ANDA DI SINI

// State aplikasi untuk menyimpan semua data
const attendanceData = {
    foto: null,
    locationMasuk: null,
    locationPulang: null,
    dateMasuk: new Date().toLocaleDateString('id-ID'),
    name: null,
    email: null,
    division: null,
    position: null,
    dutyAs: null,
    workType: null,
    statusAbsen: 'on working',
    absenMasuk: null,
    statusMasuk: null,
    alasanTerlambat: '',
    absenPulang: null,
    statusPulang: null,
    totalOvertime: '0 jam 0 menit',
    totalWorktime: null,
    remark: '',
    fotoPekerjaan: null,
};

// Elemen DOM
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const context = canvas.getContext('2d');
const captureBtn = document.getElementById('capture-btn');
const absenMasukBtn = document.getElementById('absen-masuk-btn');
const absenPulangBtn = document.getElementById('absen-pulang-btn');
const kirimLaporanBtn = document.getElementById('kirim-laporan-btn');

// Inisialisasi Kamera
async function setupCamera() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        video.srcObject = stream;
        video.addEventListener('loadedmetadata', () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
        });
    } catch (err) {
        console.error("Error accessing camera: ", err);
        alert("Tidak bisa mengakses kamera. Pastikan Anda memberikan izin.");
    }
}

// Mengambil Foto
captureBtn.addEventListener('click', () => {
    context.drawImage(video, 0, 0, canvas.width, canvas.height);
    video.classList.add('hidden');
    canvas.classList.remove('hidden');
    attendanceData.foto = canvas.toDataURL('image/jpeg');
    captureBtn.textContent = 'Foto Diambil!';
    captureBtn.classList.remove('btn-primary');
    captureBtn.classList.add('btn-disabled');
    absenMasukBtn.disabled = false;
    absenMasukBtn.classList.remove('btn-disabled');
});

// Mendapatkan Lokasi Geografis
function getLocation() {
    return new Promise((resolve, reject) => {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                resolve(`${lat}, ${lon}`);
            }, () => {
                reject('Tidak bisa mendapatkan lokasi. Pastikan GPS aktif dan izin diberikan.');
            });
        } else {
            reject('Geolocation tidak didukung oleh browser ini.');
        }
    });
}

// Fungsi untuk memformat durasi
function formatDuration(ms) {
    if (ms < 0) ms = 0;
    const totalSeconds = Math.floor(ms / 1000);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    return `${hours} jam, ${minutes} menit, ${seconds} detik`;
}


// Event Listener untuk Tombol Absen Masuk
absenMasukBtn.addEventListener('click', async () => {
    // Validasi input data diri
    const name = document.getElementById('name').value;
    const email = document.getElementById('email').value;
    const division = document.getElementById('division').value;
    const position = document.getElementById('position').value;
    const dutyAs = document.getElementById('duty_as').value;
    const workType = document.getElementById('work_type').value;

    if (!name || !email || !division || !position || !dutyAs) {
        alert('Harap lengkapi semua field di bagian Data Diri & Pekerjaan.');
        return;
    }
    
    // Simpan data diri
    attendanceData.name = name;
    attendanceData.email = email;
    attendanceData.division = division;
    attendanceData.position = position;
    attendanceData.dutyAs = dutyAs;
    attendanceData.workType = workType;

    // Ambil lokasi dan waktu
    try {
        attendanceData.locationMasuk = await getLocation();
    } catch (error) {
        alert(error);
        return;
    }

    const now = new Date();
    attendanceData.absenMasuk = now;

    // Cek status masuk
    const jamMasuk = now.getHours();
    const menitMasuk = now.getMinutes();
    const statusMasukContainer = document.getElementById('status-masuk-container');
    const statusMasukText = document.getElementById('status-masuk-text');
    const alasanContainer = document.getElementById('alasan-terlambat-container');

    if (jamMasuk < 9 || (jamMasuk === 9 && menitMasuk === 0)) {
        attendanceData.statusMasuk = 'Terima Kasih Anda Telah Absen Tepat Waktu';
        statusMasukText.textContent = attendanceData.statusMasuk;
        statusMasukContainer.classList.add('border-green-500', 'bg-green-50');
    } else {
        attendanceData.statusMasuk = 'Anda Terlambat Absen';
        statusMasukText.textContent = attendanceData.statusMasuk;
        statusMasukContainer.classList.add('border-red-500', 'bg-red-50');
        alasanContainer.classList.remove('hidden');
    }

    statusMasukContainer.classList.remove('hidden');
    
    // Update UI
    absenMasukBtn.textContent = `Absen Masuk Tercatat: ${now.toLocaleTimeString('id-ID')}`;
    absenMasukBtn.disabled = true;
    absenMasukBtn.classList.add('btn-disabled');
    document.getElementById('form-data-diri').querySelectorAll('input, select').forEach(el => el.disabled = true);
    document.getElementById('form-absen-pulang').classList.remove('hidden');
});


// Event Listener untuk Tombol Absen Pulang
absenPulangBtn.addEventListener('click', async () => {
    // Ambil data dari form pulang
    attendanceData.alasanTerlambat = document.getElementById('alasan_terlambat').value;
    attendanceData.remark = document.getElementById('remark').value;
    
    // Ambil lokasi dan waktu pulang
    try {
        attendanceData.locationPulang = await getLocation();
    } catch (error) {
        alert(error);
        return;
    }

    const now = new Date();
    attendanceData.absenPulang = now;
    attendanceData.statusAbsen = 'pulang';
    
    // Cek status pulang
    const jamPulang = now.getHours();
    const menitPulang = now.getMinutes();
    const statusPulangContainer = document.getElementById('status-pulang-container');
    const statusPulangText = document.getElementById('status-pulang-text');

    if (jamPulang < 17) {
        attendanceData.statusPulang = 'Anda Pulang Sebelum Waktunya';
        statusPulangContainer.classList.add('border-yellow-500', 'bg-yellow-50');
    } else if (jamPulang === 17 && menitPulang <= 30) {
        attendanceData.statusPulang = 'Anda Pulang Tepat Waktu';
        statusPulangContainer.classList.add('border-green-500', 'bg-green-50');
    } else {
        attendanceData.statusPulang = 'Waktu Kerja Melebihi';
        statusPulangContainer.classList.add('border-blue-500', 'bg-blue-50');
        
        // Hitung overtime
        const targetPulang = new Date(now);
        targetPulang.setHours(17, 31, 0, 0);
        if (now > targetPulang) {
            const overtimeMs = now.getTime() - targetPulang.getTime();
            attendanceData.totalOvertime = formatDuration(overtimeMs);
        }
    }
    statusPulangText.textContent = `Status: ${attendanceData.statusPulang}`;

    // Hitung total worktime
    const worktimeMs = attendanceData.absenPulang.getTime() - attendanceData.absenMasuk.getTime();
    attendanceData.totalWorktime = formatDuration(worktimeMs);
    
    // Tampilkan info
    document.getElementById('total-worktime-text').textContent = `Total Waktu Kerja: ${attendanceData.totalWorktime}`;
    document.getElementById('total-overtime-text').textContent = `Total Overtime: ${attendanceData.totalOvertime}`;
    statusPulangContainer.classList.remove('hidden');

    // Update UI
    absenPulangBtn.textContent = `Absen Pulang Tercatat: ${now.toLocaleTimeString('id-ID')}`;
    absenPulangBtn.disabled = true;
    absenPulangBtn.classList.add('btn-disabled');
    document.getElementById('form-absen-pulang').querySelectorAll('textarea, input').forEach(el => el.disabled = true);
    document.getElementById('form-kirim').classList.remove('hidden');
});

// Fungsi untuk mengubah file foto pekerjaan ke Base64
function getBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
}

// Event Listener untuk Tombol Kirim Laporan
kirimLaporanBtn.addEventListener('click', async () => {
    if (!googleScriptURL) {
        alert('URL Google Script belum diatur. Harap edit file HTML dan isi variabel googleScriptURL.');
        return;
    }
    
    const loadingSpinner = document.getElementById('loading-spinner');
    const successMessage = document.getElementById('success-message');
    const errorMessage = document.getElementById('error-message');
    
    loadingSpinner.classList.remove('hidden');
    kirimLaporanBtn.disabled = true;
    kirimLaporanBtn.classList.add('btn-disabled');
    successMessage.classList.add('hidden');
    errorMessage.classList.add('hidden');

    // Handle foto pekerjaan
    const fotoPekerjaanFile = document.getElementById('foto_pekerjaan').files[0];
    if (fotoPekerjaanFile) {
        try {
            attendanceData.fotoPekerjaan = await getBase64(fotoPekerjaanFile);
        } catch (error) {
            console.error("Error converting work photo to Base64:", error);
            alert("Gagal memproses foto pekerjaan.");
            loadingSpinner.classList.add('hidden');
            kirimLaporanBtn.disabled = false;
            kirimLaporanBtn.classList.remove('btn-disabled');
            return;
        }
    }

    // Ubah format tanggal agar mudah dibaca di spreadsheet
    const finalData = { ...attendanceData };
    finalData.absenMasuk = finalData.absenMasuk.toLocaleString('id-ID', { dateStyle: 'full', timeStyle: 'long' });
    finalData.absenPulang = finalData.absenPulang.toLocaleString('id-ID', { dateStyle: 'full', timeStyle: 'long' });

    try {
        const response = await fetch(googleScriptURL, {
            method: 'POST',
            mode: 'no-cors', // Penting untuk Google Script Web App
            cache: 'no-cache',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({data: finalData})
        });
        
        // Karena mode 'no-cors', kita tidak bisa membaca response.
        // Kita asumsikan berhasil jika tidak ada error network.
        loadingSpinner.classList.add('hidden');
        successMessage.classList.remove('hidden');

    } catch (error) {
        console.error('Error:', error);
        loadingSpinner.classList.add('hidden');
        errorMessage.classList.remove('hidden');
        kirimLaporanBtn.disabled = false;
        kirimLaporanBtn.classList.remove('btn-disabled');
    }
});


// Jalankan setup kamera saat halaman dimuat
window.addEventListener('load', setupCamera);
</script>
</body>
</html>
