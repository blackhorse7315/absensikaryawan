<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecrew - Absensi Karyawan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- LeafletJS CSS for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .glassmorphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .btn-primary {
            background-color: #1E3A8A; /* Dark Blue */
            color: white;
            transition: background-color 0.3s, transform 0.2s;
        }
        .btn-primary:hover {
            background-color: #1C3473;
            transform: scale(1.05);
        }
        .btn-secondary {
            background-color: #4B5563; /* Gray-600 */
            color: #E5E7EB; /* Gray-200 */
            transition: background-color 0.3s, transform 0.2s;
        }
        .btn-secondary:hover {
            background-color: #6B7280; /* Gray-500 */
            transform: scale(1.05);
        }
        .hidden {
            display: none;
        }
        /* Leaflet map height */
        .leaflet-container {
            height: 200px;
            border-radius: 0.5rem;
        }
        /* Custom select style */
        .custom-select {
            background-color: #374151; /* bg-gray-700 */
            border: 1px solid #4B5563; /* border-gray-600 */
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .summary-item:last-child {
            border-bottom: none;
        }
        .summary-label {
            color: #9CA3AF; /* text-slate-400 */
        }
        .summary-value {
            font-weight: 600;
            text-align: right;
        }
    </style>
</head>
<body class="bg-slate-900 text-white flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-md mx-auto">
        <!-- Login Screen -->
        <div id="login-screen" class="glassmorphism p-8 rounded-2xl shadow-lg">
            <div class="text-center mb-8">
                <img src="https://placehold.co/150x50/1E3A8A/FFFFFF?text=ECREW" alt="Ecrew Logo" class="mx-auto mb-4 rounded">
                <h1 class="text-2xl font-bold text-white">PT. Transwisata Prima Aviation</h1>
                <p class="text-slate-300">Sistem Absensi Karyawan</p>
            </div>
            <form id="login-form">
                <div class="mb-4">
                    <label for="email-input" class="block mb-2 text-sm font-medium text-slate-300">Email Anda</label>
                    <input type="email" id="email-input" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan email terdaftar..." required>
                </div>
                <button type="submit" class="w-full btn-primary font-bold py-3 px-4 rounded-lg shadow-md">Login</button>
            </form>
        </div>

        <!-- Main App Screen -->
        <div id="app-screen" class="hidden">
            <div class="text-center mb-6">
                <h1 id="greeting" class="text-3xl font-bold">Selamat Pagi, Nama</h1>
                <p id="current-date" class="text-slate-400 text-lg"></p>
                <p id="current-time" class="text-slate-200 text-4xl font-bold mt-2"></p>
            </div>

            <div class="glassmorphism p-6 rounded-2xl shadow-lg space-y-6">
                
                <!-- Check-in Section -->
                <div id="check-in-section" class="space-y-4">
                    <div class="text-center bg-slate-800/50 p-4 rounded-lg">
                        <p class="font-semibold text-xl" id="user-name"></p>
                        <p class="text-slate-300" id="user-position"></p>
                        <p class="text-slate-400 text-sm" id="user-division"></p>
                    </div>
                    
                    <button id="history-btn" class="w-full btn-secondary font-bold py-3 px-4 rounded-lg text-md shadow-lg flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>
                        Lihat Riwayat Absen
                    </button>

                    <div id="live-location-container">
                        <label class="block text-sm font-medium text-slate-300 mb-2">Lokasi Anda Saat Ini:</label>
                        <div id="live-location-map"></div>
                         <p id="location-loader" class="text-center text-slate-400 p-4">Memuat peta lokasi...</p>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label for="duty-as-select" class="block text-sm font-medium text-slate-300 mb-2">Duty As</label>
                            <select id="duty-as-select" class="w-full p-3 rounded-lg custom-select">
                                <option value="" disabled selected>Pilih Duty As...</option>
                                <option>Director</option><option>Safety, Quality & Security Manager</option><option>Operation Manager</option><option>Maintenance Manager</option><option>Chief Pilot Fixed Wing</option><option>Chief Pilot Rotary Wing</option><option>Chief Flight Support</option><option>Chief Inspector</option><option>Chief Engineer</option><option>Chief Finance, Accounting & Staf</option><option>Chief Engineering</option><option>Pilot in Command</option><option>Second in Command</option><option>Ground Instructor</option><option>Flight Instructor</option><option>Company Check Pilot</option><option>Engineer</option><option>Line Pilot</option><option>Cabin Service</option><option>Student</option><option>Flight Support</option><option>Ground Support</option><option>Technical Representative</option><option>Engineering</option><option>Staff</option><option>Logistic</option><option>Aviation Security</option><option>Driver</option>
                            </select>
                        </div>
                        <div>
                            <label for="work-type-select" class="block text-sm font-medium text-slate-300 mb-2">Tipe Pekerjaan</label>
                            <select id="work-type-select" class="w-full p-3 rounded-lg custom-select">
                                <option value="" disabled selected>Pilih Tipe Pekerjaan...</option>
                                <option>Office Hour</option><option>Standby Flight</option><option>Standby on Call</option><option>Pos One Gate</option><option>Day Off</option><option>Day Off 7 Consecutive Days for Pilot</option><option>Flight Duty VIP</option><option>Ferry Flight</option><option>PPC Simulator</option><option>PPC Aircraft</option><option>Test Flight</option><option>Ground Run</option><option>Recurrent Training</option><option>Recency Flight</option><option>Meeting Out of Office</option><option>Medical Examination</option><option>Annual Leave</option><option>Sick</option><option>Technical Representative</option><option>Aviation Security</option><option>Over Time</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="late-reason-section" class="hidden space-y-2">
                        <label for="late-reason" class="block text-sm font-medium text-red-400">Alasan Terlambat (Wajib Diisi)</label>
                        <textarea id="late-reason" rows="3" class="w-full p-3 bg-slate-700 border border-red-500 rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="Jelaskan alasan keterlambatan Anda..."></textarea>
                    </div>

                    <button id="check-in-btn" class="w-full btn-primary font-bold py-4 px-4 rounded-lg text-xl shadow-lg flex items-center justify-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
                        Ambil Foto & Absen Masuk
                    </button>
                </div>

                <!-- On Working Section -->
                <div id="on-working-section" class="hidden space-y-4">
                     <div class="bg-green-900/50 border border-green-700 text-green-200 px-4 py-3 rounded-lg text-center">
                        <p class="font-bold">Status: On Working</p>
                        <p class="text-sm" id="check-in-time-status"></p>
                        <p class="text-sm font-bold mt-1" id="check-in-status-message"></p>
                    </div>

                    <div id="check-in-map-container" class="hidden">
                        <label class="block text-sm font-medium text-slate-300 mb-2">Lokasi Masuk Anda:</label>
                        <div id="check-in-map"></div>
                    </div>

                    <div id="work-remark-section" class="space-y-4">
                        <div>
                            <label for="work-remark" class="block mb-2 text-sm font-medium text-slate-300">Remark Pekerjaan Hari Ini</label>
                            <textarea id="work-remark" rows="4" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Tuliskan ringkasan pekerjaan Anda hari ini..."></textarea>
                        </div>
                        <div>
                            <label for="work-photo" class="block mb-2 text-sm font-medium text-slate-300">Foto Pekerjaan Hari Ini</label>
                            <input type="file" id="work-photo" accept="image/*" class="w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-900/50 file:text-blue-200 hover:file:bg-blue-800/50">
                        </div>
                    </div>

                    <button id="check-out-btn" class="w-full btn-secondary font-bold py-4 px-4 rounded-lg text-xl shadow-lg flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                        Absen Pulang
                    </button>
                </div>

                <!-- Summary Section -->
                <div id="summary-section" class="hidden space-y-4">
                    <h2 class="text-2xl font-bold text-center">Laporan Absensi Hari Ini</h2>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center">
                            <p class="font-semibold mb-2">Foto Masuk</p>
                            <img id="summary-photo-masuk" src="https://placehold.co/200x200/334155/e2e8f0?text=Foto" alt="Foto Masuk" class="rounded-lg w-full h-auto aspect-square object-cover">
                        </div>
                        <div class="text-center">
                            <p class="font-semibold mb-2">Foto Pekerjaan</p>
                            <img id="summary-photo-pekerjaan" src="https://placehold.co/200x200/334155/e2e8f0?text=Foto" alt="Foto Pekerjaan" class="rounded-lg w-full h-auto aspect-square object-cover">
                        </div>
                    </div>

                    <div class="bg-slate-800/50 p-4 rounded-lg space-y-2">
                        <div class="summary-item">
                            <span class="summary-label">Nama</span>
                            <span id="summary-name" class="summary-value"></span>
                        </div>
                         <div class="summary-item">
                            <span class="summary-label">Duty / Tipe Kerja</span>
                            <span id="summary-duty-work" class="summary-value"></span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Absen Masuk</span>
                            <span id="summary-absen-masuk" class="summary-value"></span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Status Masuk</span>
                            <span id="summary-status-masuk" class="summary-value"></span>
                        </div>
                         <div id="summary-late-reason-item" class="summary-item hidden">
                            <span class="summary-label">Alasan Terlambat</span>
                            <span id="summary-late-reason" class="summary-value"></span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Absen Pulang</span>
                            <span id="summary-absen-pulang" class="summary-value"></span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Status Pulang</span>
                            <span id="summary-status-pulang" class="summary-value"></span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Total Jam Kerja</span>
                            <span id="summary-total-worktime" class="summary-value text-green-400"></span>
                        </div>
                        <div id="summary-overtime-item" class="summary-item hidden">
                            <span class="summary-label">Total Overtime</span>
                            <span id="summary-total-overtime" class="summary-value text-yellow-400"></span>
                        </div>
                    </div>
                    
                    <div>
                        <p class="font-semibold mb-2 text-center">Remark Pekerjaan</p>
                        <p id="summary-remark" class="bg-slate-800/50 p-3 rounded-lg text-slate-300 text-sm"></p>
                    </div>

                    <div>
                        <p class="font-semibold mb-2 text-center">Peta Lokasi Absen</p>
                        <div id="summary-map"></div>
                    </div>

                    <button id="reset-btn" class="w-full btn-primary font-bold py-3 px-4 rounded-lg mt-4">Selesai</button>
                </div>

                <!-- History Section -->
                <div id="history-section" class="hidden space-y-4">
                    <h2 class="text-2xl font-bold text-center">Riwayat Absensi</h2>
                    <div id="history-container" class="space-y-3 max-h-96 overflow-y-auto">
                        <!-- History cards will be injected here -->
                    </div>
                    <button id="back-to-main-btn" class="w-full btn-secondary font-bold py-3 px-4 rounded-lg">Kembali</button>
                </div>

            </div>
        </div>
    </div>

    <!-- Camera Modal -->
    <div id="camera-modal" class="hidden fixed inset-0 bg-black bg-opacity-90 flex flex-col items-center justify-center p-4 z-50">
        <video id="camera-stream" class="w-full max-w-md rounded-lg" autoplay playsinline></video>
        <canvas id="camera-canvas" class="hidden"></canvas>
        <div class="mt-4 flex gap-4">
            <button id="capture-btn" class="w-16 h-16 bg-white rounded-full border-4 border-slate-500"></button>
            <button id="cancel-camera-btn" class="absolute top-4 right-4 text-white bg-red-600 rounded-full w-10 h-10 flex items-center justify-center text-xl">&times;</button>
        </div>
    </div>

    <!-- Modal for messages -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="bg-slate-800 rounded-2xl p-8 shadow-lg text-center max-w-sm w-full">
            <p id="modal-message" class="text-lg mb-6"></p>
            <button id="modal-close-btn" class="btn-primary font-bold py-2 px-6 rounded-lg">OK</button>
        </div>
    </div>

    <!-- LeafletJS JS for Maps -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- URL SUDAH DIMASUKKAN ---
            const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbycydAIlGH-HmLFKmmmBuSqUi5qZilY_WR9sgFfeWs_1FBrcp61lLR3K4AuVUUQa46kCg/exec';

            // --- DOM ELEMENTS ---
            const loginScreen = document.getElementById('login-screen');
            const appScreen = document.getElementById('app-screen');
            const loginForm = document.getElementById('login-form');
            const emailInput = document.getElementById('email-input');
            const greeting = document.getElementById('greeting');
            const currentDateEl = document.getElementById('current-date');
            const currentTimeEl = document.getElementById('current-time');
            const userInfo = {
                name: document.getElementById('user-name'),
                position: document.getElementById('user-position'),
                division: document.getElementById('user-division'),
            };
            const dutyAsSelect = document.getElementById('duty-as-select');
            const workTypeSelect = document.getElementById('work-type-select');
            const liveLocationContainer = document.getElementById('live-location-container');
            const locationLoader = document.getElementById('location-loader');

            const checkInSection = document.getElementById('check-in-section');
            const onWorkingSection = document.getElementById('on-working-section');
            const summarySection = document.getElementById('summary-section');
            const historySection = document.getElementById('history-section');

            const checkInBtn = document.getElementById('check-in-btn');
            const checkOutBtn = document.getElementById('check-out-btn');
            const resetBtn = document.getElementById('reset-btn');
            const historyBtn = document.getElementById('history-btn');
            const backToMainBtn = document.getElementById('back-to-main-btn');

            const checkInStatusMessage = document.getElementById('check-in-status-message');
            const checkInTimeStatus = document.getElementById('check-in-time-status');
            const lateReasonSection = document.getElementById('late-reason-section');
            const lateReasonInput = document.getElementById('late-reason');
            const modal = document.getElementById('modal');
            const modalMessage = document.getElementById('modal-message');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const checkInMapContainer = document.getElementById('check-in-map-container');
            
            // Camera Modal Elements
            const cameraModal = document.getElementById('camera-modal');
            const videoStream = document.getElementById('camera-stream');
            const canvas = document.getElementById('camera-canvas');
            const captureBtn = document.getElementById('capture-btn');
            const cancelCameraBtn = document.getElementById('cancel-camera-btn');
            
            // Summary Elements
            const summaryElements = {
                photoMasuk: document.getElementById('summary-photo-masuk'),
                photoPekerjaan: document.getElementById('summary-photo-pekerjaan'),
                name: document.getElementById('summary-name'),
                dutyWork: document.getElementById('summary-duty-work'),
                absenMasuk: document.getElementById('summary-absen-masuk'),
                statusMasuk: document.getElementById('summary-status-masuk'),
                lateReasonItem: document.getElementById('summary-late-reason-item'),
                lateReason: document.getElementById('summary-late-reason'),
                absenPulang: document.getElementById('summary-absen-pulang'),
                statusPulang: document.getElementById('summary-status-pulang'),
                totalWorktime: document.getElementById('summary-total-worktime'),
                overtimeItem: document.getElementById('summary-overtime-item'),
                totalOvertime: document.getElementById('summary-total-overtime'),
                remark: document.getElementById('summary-remark'),
                map: document.getElementById('summary-map'),
            };


            // --- APP STATE ---
            let appState = {
                loggedInUser: null,
                currentLocation: null,
                attendanceData: null,
            };
            let mapInstances = {};
            let currentStream;

            // --- USER DATABASE ---
            const users = [
                { name: 'Rustam Suhanda', email: 'managementtranswisata@gmail.com', division: 'Staf', position: 'President Director' },
                { name: 'Selfy Warauw', email: 'warauw_1@yahoo.com', division: 'Staf', position: 'Director' },
                { name: 'Muhamad Ramdani Masri', email: 'crunkbolcow@gmail.com', division: 'Operation', position: 'Chief Pilot Rotary Wing' },
                { name: 'Sulaksono Teddy Prabowo', email: 'fly5103@gmail.com', division: 'Operation', position: 'Line Pilot' },
                { name: 'Marcelino Bhaharoenawanto', email: 'marcelino412ep@gmail.com', division: 'Operation', position: 'Line Pilot' },
                { name: 'Muhamad Sofwan', email: 'sofwanm819@gmail.com', division: 'Operation', position: 'Chief Pilot Fixed Wing' },
                { name: 'Sofian M. L. Tobing', email: 'sofiantobing692@gmail.com', division: 'Operation', position: 'General Manager' },
                { name: 'Rico Febdiandana', email: 'ricofebdi@gmail.com', division: 'Operation', position: 'Chief Flight Support' },
                { name: 'Alfajri', email: 'alfajri_koto@yahoo.com', division: 'Operation', position: 'Line Pilot' },
                { name: 'Eli Setya', email: 'tioxpilot@gmail.com', division: 'Operation', position: 'Line Pilot' },
                { name: 'Susetyo Harijanto', email: 'harijantosusetyo@gmail.com', division: 'Operation', position: 'Operation Manager' },
                { name: 'Purwoko', email: 'purwoko.mulyono@yahoo.com', division: 'Operation', position: 'Line Pilot' },
                { name: 'Riza Hanindita', email: 'icul2122@gmail.com', division: 'Operation', position: 'Line Pilot' },
                { name: 'Henaldy Arifia Sudrajat', email: 'henaldy.ts204@gmail.com', division: 'Operation', position: 'Line Pilot' },
                { name: 'Kadek Amelia Nadya Berliana', email: 'amelberliana@yahoo.co.id', division: 'Operation', position: 'Line Pilot' },
                { name: 'Qorry Maulidya Natawijaya', email: 'qnatawijaya@gmail.com', division: 'Operation', position: 'Cabin Service' },
                { name: 'Shentira Anggia Putri', email: 'anggiashentira@gmail.com', division: 'Operation', position: 'Cabin Service' },
                { name: 'Tiffani Pricilia Hasan', email: 'tiffanipriciliaaaa@gmail.com', division: 'Operation', position: 'Cabin Service' },
                { name: 'Agustin Zulfani Prihatini', email: 'agustinzulfani74@gmail.com', division: 'Operation', position: 'Cabin Service' },
                { name: 'Nadya Casey Ivanka', email: 'ivankacasey99@gmail.com', division: 'Operation', position: 'Cabin Service' },
                { name: 'Yanu Prihatno', email: 'prihatnoyanu@gmail.com', division: 'Maintenance', position: 'Engineer' },
                { name: 'Bayu Nugroho', email: 'bayu.avicena@gmail.com', division: 'Maintenance', position: 'Engineer' },
                { name: 'Wahyudi Suseno', email: 'nawawahyudisuseno090@gmail.com', division: 'Maintenance', position: 'Avionic' },
                { name: 'Sigit Hardadi', email: 'sigithardadi88@yahoo.com', division: 'Maintenance', position: 'Engineer' },
                { name: 'Hadi Sutrisno', email: 'hadikamilatun@gmail.com', division: 'Maintenance', position: 'Maintenance Manager' },
                { name: 'Suhairi', email: 'suhairitwa@gmail.com', division: 'Maintenance', position: 'Engineer' },
                { name: 'Suyanto', email: 'yanto.umardin@gmail.com', division: 'Maintenance', position: 'Avionic' },
                { name: 'Lazarus Rio Raymond', email: 'rioraymond89@gmail.com', division: 'Maintenance', position: 'Engineer' },
                { name: 'Febie Aguti Effendi', email: 'mpiipie@gmail.com', division: 'Maintenance', position: 'Engineer' },
                { name: 'Diki Hariyanto', email: 'dikiatnu7@gmail.com', division: 'Maintenance', position: 'Chief Engineer' },
                { name: 'Prayit Susonggo', email: 'prayitsusonggo@yahoo.com', division: 'Maintenance', position: 'Avionic' },
                { name: 'Iskandar Akbar Hakim', email: 'iskandarakbarhakim@gmail.com', division: 'Maintenance', position: 'Chief Inspector' },
                { name: 'Arif Vrybadi Halim', email: 'GlexXRSvpcgo@outlook.com', division: 'Maintenance', position: 'Engineer' },
                { name: 'Alfiza Eka Putra', email: 'alfizaekap@gmail.com', division: 'Maintenance', position: 'Engineer' },
                { name: 'Dedi Prasetyo', email: 'deditren99@gmail.com', division: 'Safety', position: 'Aviation Security' },
                { name: 'Media H Marbun', email: 'mediamarbun@gmail.com', division: 'Staf', position: 'Human Resource Development' },
                { name: 'Fatmawati', email: 'ulieumeda@gmail.com', division: 'Staf', position: 'Finance' },
                { name: 'Dede Rahman Arafiq', email: 'd2rahman@yahoo.co.id', division: 'Staf', position: 'Finance' },
                { name: 'Leo Fitzgerald Sinay', email: 'leosinay@gmail.com', division: 'Maintenance', position: 'Chief Engineering' },
                { name: 'Khairul Zaman Pohan', email: 'pohan16zaman@gmail.com', division: 'Operation', position: 'Flight Support' },
                { name: 'Sentot Basuki', email: 'sentotbasuki@gmail.com', division: 'Operation', position: 'Flight Support' },
                { name: 'Bobby Feisal Mahardhika', email: 'bobby.feisal22@gmail.com', division: 'Staf', position: 'Engineering' },
                { name: 'Tri Widayat', email: 'tri3wiwid@gmail.com', division: 'Operation', position: 'Flight Support' },
                { name: 'Isdarminto', email: 'is.darminto35@gmail.com', division: 'Staf', position: 'Logistic' },
                { name: 'Sulaichan Noor Ali', email: 'sulaichann@gmail.com', division: 'Staf', position: 'Logistic' },
                { name: 'Sri Muljono Bayu Putro', email: 'sbayuputro@gmail.com', division: 'Operation', position: 'Flight Support' },
                { name: 'Asri Gatot Yulianto', email: 'Asrigatot.67@gmail.com', division: 'Safety', position: 'Aviation Security' },
                { name: 'Nanang Chabibi', email: 'nanangchabibi3@gmail.com', division: 'Safety', position: 'Aviation Security' },
                { name: 'Hariyanto', email: 'katellisna423@gmail.com', division: 'Safety', position: 'Aviation Security' },
                { name: 'Supriyono', email: 'fardhan0509@gmail.com', division: 'Staf', position: 'Kurir' },
                { name: 'Kasna', email: 'kasna.pjln799@gmail.com', division: 'Staf', position: 'Driver' },
                { name: 'Rizal Setiawan', email: 'rizalsetiawan020812@gmail.com', division: 'Staf', position: 'Driver' },
                { name: 'Ardi Rizki', email: 'ardi.rizk91@gmail.com', division: 'Maintenance', position: 'Engineer' },
                { name: 'Wawan Setiawan', email: 'setiawanwawan7312@gmail.com', division: 'Operation', position: 'Line Pilot' },
                { name: 'Tommy Saputra', email: 'tommysaputra473@gmail.com', division: 'Staf', position: 'Chief Finance, Accounting & Tax' },
                { name: 'Mochamad Riza', email: 'mch_riza@yahoo.com', division: 'Safety', position: 'Quality, Safety, Security Manager' },
                { name: 'Alexander Anggarda Yunan Devata', email: 'alexanderdevata@yahoo.co.id', division: 'Operation', position: 'Flight Support' },
                { name: 'Sukyono', email: 'sskkyy020@gmail.com', division: 'Operation', position: 'Flight Support' }
            ];

            // --- FUNCTIONS ---

            async function sendDataToSpreadsheet(data) {
                if (!APPS_SCRIPT_URL) {
                    console.warn("APPS_SCRIPT_URL is not set. Skipping spreadsheet submission.");
                    return;
                }

                const payload = { ...data };
                if (payload.absenMasuk instanceof Date) payload.absenMasuk = payload.absenMasuk.toISOString();
                if (payload.absenPulang instanceof Date) payload.absenPulang = payload.absenPulang.toISOString();
                delete payload.fotoMasuk;
                delete payload.fotoPekerjaan;

                try {
                    await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });
                    console.log("Data sent to spreadsheet.");
                } catch (error) {
                    console.error("Error sending data to spreadsheet:", error);
                    showModal("Gagal mengirim data ke spreadsheet. Data tersimpan lokal.");
                }
            }
            
            async function fetchFromSpreadsheet(action, email) {
                if (!APPS_SCRIPT_URL) {
                    showModal("URL Spreadsheet belum diatur.");
                    return null;
                }
                const url = `${APPS_SCRIPT_URL}?action=${action}&email=${encodeURIComponent(email)}`;
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error("Network response was not ok.");
                    }
                    return await response.json();
                } catch (error) {
                    console.error("Error fetching from spreadsheet:", error);
                    showModal("Gagal mengambil data dari spreadsheet. Cek koneksi Anda.");
                    return null;
                }
            }

            function showModal(message) {
                modalMessage.textContent = message;
                modal.classList.remove('hidden');
            }
            
            modalCloseBtn.addEventListener('click', () => modal.classList.add('hidden'));

            function updateDateTime() {
                const now = new Date();
                const optionsDate = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                currentDateEl.textContent = now.toLocaleDateString('id-ID', optionsDate);
                currentTimeEl.textContent = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                
                const hours = now.getHours();
                if (appState.loggedInUser) {
                    if (hours < 12) {
                        greeting.textContent = `Selamat Pagi, ${appState.loggedInUser.name.split(' ')[0]}`;
                    } else if (hours < 15) {
                        greeting.textContent = `Selamat Siang, ${appState.loggedInUser.name.split(' ')[0]}`;
                    } else if (hours < 18) {
                        greeting.textContent = `Selamat Sore, ${appState.loggedInUser.name.split(' ')[0]}`;
                    } else {
                        greeting.textContent = `Selamat Malam, ${appState.loggedInUser.name.split(' ')[0]}`;
                    }
                }
            }

            function getLocation() {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        reject({ message: 'Geolocation tidak didukung oleh browser Anda.' });
                    } else {
                        navigator.geolocation.getCurrentPosition(
                            (position) => resolve({
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                                text: `${position.coords.latitude}, ${position.coords.longitude}`
                            }),
                            (error) => {
                                let message;
                                switch(error.code) {
                                    case error.PERMISSION_DENIED:
                                        message = "Anda menolak izin akses lokasi. Absensi tidak dapat dilanjutkan."; break;
                                    case error.POSITION_UNAVAILABLE:
                                        message = "Informasi lokasi tidak tersedia. Pastikan GPS Anda aktif."; break;
                                    case error.TIMEOUT:
                                        message = "Waktu permintaan lokasi habis. Coba lagi."; break;
                                    default:
                                        message = "Terjadi kesalahan saat mengambil lokasi."; break;
                                }
                                reject({ message: message });
                            },
                            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                        );
                    }
                });
            }

            function displayMap(containerId, coords, message = 'Lokasi Anda') {
                 if (mapInstances[containerId]) {
                    mapInstances[containerId].remove();
                }
                const map = L.map(containerId).setView([coords.lat, coords.lng], 16);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                L.marker([coords.lat, coords.lng]).addTo(map)
                    .bindPopup(message)
                    .openPopup();
                mapInstances[containerId] = map;
                setTimeout(() => map.invalidateSize(), 100);
            }

            function displaySummaryMap(checkInCoords, checkOutCoords) {
                const containerId = 'summary-map';
                if (mapInstances[containerId]) {
                    mapInstances[containerId].remove();
                }
                const map = L.map(containerId);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                
                const checkInMarker = L.marker([checkInCoords.lat, checkInCoords.lng]).addTo(map).bindPopup('Lokasi Masuk');
                const checkOutMarker = L.marker([checkOutCoords.lat, checkOutCoords.lng]).addTo(map).bindPopup('Lokasi Pulang');
                
                const group = new L.featureGroup([checkInMarker, checkOutMarker]);
                map.fitBounds(group.getBounds().pad(0.5));
                mapInstances[containerId] = map;
                setTimeout(() => map.invalidateSize(), 100);
            }


            function formatDuration(ms) {
                if (ms < 0) ms = 0;
                const totalSeconds = Math.floor(ms / 1000);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }
            
            function handleLateVisibility() {
                const now = new Date();
                const currentTimeInMinutes = now.getHours() * 60 + now.getMinutes();
                const lateThreshold = 9 * 60 + 1; // 09:01
                
                if (currentTimeInMinutes >= lateThreshold) {
                    lateReasonSection.classList.remove('hidden');
                } else {
                    lateReasonSection.classList.add('hidden');
                }
            }

            async function initializeCheckinView() {
                handleLateVisibility();
                try {
                    const location = await getLocation();
                    appState.currentLocation = location;
                    locationLoader.classList.add('hidden');
                    displayMap('live-location-map', location);
                } catch (error) {
                    locationLoader.textContent = `Gagal memuat lokasi: ${error.message}`;
                    showModal(error.message);
                }
            }
            
            function populateSummary(data) {
                // For summary, we might need to retrieve photos from a temporary storage if needed
                // For now, we'll use placeholders as photos are not in the history object
                summaryElements.photoMasuk.src = data.fotoMasuk || "https://placehold.co/200x200/334155/e2e8f0?text=No+Img";
                summaryElements.photoPekerjaan.src = data.fotoPekerjaan || "https://placehold.co/200x200/334155/e2e8f0?text=No+Img";
                summaryElements.name.textContent = data.Nama;
                summaryElements.dutyWork.textContent = `${data['Duty As']} / ${data['Tipe Pekerjaan']}`;
                summaryElements.absenMasuk.textContent = new Date(data['Absen Masuk']).toLocaleString('id-ID');
                summaryElements.statusMasuk.textContent = data['Status Masuk'];
                if (data['Alasan Terlambat']) {
                    summaryElements.lateReason.textContent = data['Alasan Terlambat'];
                    summaryElements.lateReasonItem.classList.remove('hidden');
                } else {
                    summaryElements.lateReasonItem.classList.add('hidden');
                }
                summaryElements.absenPulang.textContent = new Date(data['Absen Pulang']).toLocaleString('id-ID');
                summaryElements.statusPulang.textContent = data['Status Pulang'];
                summaryElements.totalWorktime.textContent = data['Total Jam Kerja'];
                 if (data['Total Overtime'] && data['Total Overtime'] !== '00:00:00') {
                    summaryElements.totalOvertime.textContent = data['Total Overtime'];
                    summaryElements.overtimeItem.classList.remove('hidden');
                } else {
                    summaryElements.overtimeItem.classList.add('hidden');
                }
                summaryElements.remark.textContent = data['Remark Pekerjaan'];
                
                // Location text is stored, not coords object. This part needs adjustment if we want to show map from history.
                // For now, we'll skip the map for historical views.
            }

            function renderUI() {
                if (appState.loggedInUser) {
                    loginScreen.classList.add('hidden');
                    appScreen.classList.remove('hidden');
                    
                    userInfo.name.textContent = appState.loggedInUser.name;
                    userInfo.position.textContent = appState.loggedInUser.position;
                    userInfo.division.textContent = appState.loggedInUser.division;

                    const hasCheckedIn = !!appState.attendanceData;
                    const hasCheckedOut = !!appState.attendanceData?.['Absen Pulang'];

                    checkInSection.classList.toggle('hidden', hasCheckedIn);
                    onWorkingSection.classList.toggle('hidden', !hasCheckedIn || hasCheckedOut);
                    summarySection.classList.toggle('hidden', !hasCheckedOut);
                    historySection.classList.add('hidden');

                    if (!hasCheckedIn) {
                        initializeCheckinView();
                    } else if (hasCheckedIn && !hasCheckedOut) {
                         checkInStatusMessage.textContent = appState.attendanceData['Status Masuk'];
                         checkInTimeStatus.textContent = `Absen Masuk: ${new Date(appState.attendanceData['Absen Masuk']).toLocaleString('id-ID')}`;
                         // Map requires coords, which we don't fetch back. We'll skip showing map here.
                         checkInMapContainer.classList.add('hidden');
                    } else if (hasCheckedOut) {
                        populateSummary(appState.attendanceData);
                    }

                } else {
                    loginScreen.classList.remove('hidden');
                    appScreen.classList.add('hidden');
                }
            }

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const enteredEmail = emailInput.value.trim().toLowerCase();
                const user = users.find(u => u.email.trim().toLowerCase() === enteredEmail);

                if (user) {
                    appState.loggedInUser = user;
                    showModal("Mengecek status terakhir...");
                    const result = await fetchFromSpreadsheet('getTodaysStatus', user.email);
                    if (result && result.status === 'found') {
                        appState.attendanceData = result.data;
                    } else {
                        appState.attendanceData = null;
                    }
                    modal.classList.add('hidden');
                    updateDateTime();
                    renderUI();
                } else {
                    showModal('Email tidak terdaftar. Mohon periksa kembali email Anda.');
                }
            });

            checkInBtn.addEventListener('click', () => {
                if (!appState.currentLocation) {
                    showModal('Lokasi belum siap. Mohon tunggu atau pastikan GPS Anda aktif.');
                    return;
                }
                const selectedDuty = dutyAsSelect.value;
                const selectedWorkType = workTypeSelect.value;

                if (!selectedDuty || !selectedWorkType) {
                    showModal('Harap pilih "Duty As" dan "Tipe Pekerjaan" sebelum melanjutkan.');
                    return;
                }

                if (!lateReasonSection.classList.contains('hidden') && !lateReasonInput.value.trim()) {
                    showModal('Anda terlambat. Harap isi alasan keterlambatan sebelum absen.');
                    return;
                }

                cameraModal.classList.remove('hidden');
                startCamera();
            });

            async function processCheckIn(photoDataUrl) {
                checkInBtn.disabled = true;
                checkInBtn.textContent = 'Memproses...';

                try {
                    const location = appState.currentLocation;
                    const now = new Date();
                    const checkInTimeInMinutes = now.getHours() * 60 + now.getMinutes();
                    const lateThreshold = 9 * 60 + 1;
                    
                    let statusMasuk;
                    let alasanTerlambat = null;
                    if (checkInTimeInMinutes >= lateThreshold) {
                        statusMasuk = 'Anda Terlambat Absen';
                        alasanTerlambat = lateReasonInput.value;
                    } else {
                        statusMasuk = 'Terima Kasih Anda Telah Absen Tepat Waktu';
                    }
                    
                    appState.attendanceData = {
                        ...appState.loggedInUser,
                        attendanceId: `ATT-${Date.now()}`,
                        dateMasuk: now.toLocaleDateString('id-ID'),
                        absenMasuk: now,
                        locationMasuk: location,
                        statusMasuk: statusMasuk,
                        alasanTerlambat: alasanTerlambat,
                        dutyAs: dutyAsSelect.value,
                        typeOfWork: workTypeSelect.value,
                        statusAbsen: 'On Working',
                        absenPulang: null,
                    };
                    
                    await sendDataToSpreadsheet(appState.attendanceData);
                    // Manually convert for UI display
                    appState.attendanceData['Status Masuk'] = statusMasuk;
                    appState.attendanceData['Absen Masuk'] = now;

                    renderUI();
                    showModal("Absen masuk berhasil!");

                } catch (error) {
                    showModal(error.message || 'Terjadi kesalahan tidak diketahui.');
                } finally {
                    checkInBtn.disabled = false;
                    checkInBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg> Ambil Foto & Absen Masuk';
                }
            }
            
            async function processCheckOut(photoDataUrl) {
                checkOutBtn.disabled = true;
                checkOutBtn.textContent = 'Memproses...';

                try {
                    const location = await getLocation();
                    const now = new Date();
                    const checkInTime = new Date(appState.attendanceData['Absen Masuk']);

                    const checkOutHour = now.getHours();
                    let statusPulang;
                    if (checkOutHour < 17) {
                        statusPulang = 'Anda Pulang Sebelum waktunya';
                    } else if (checkOutHour === 17 && now.getMinutes() <= 30) {
                        statusPulang = 'Anda Pulang tepat Waktu';
                    } else {
                        statusPulang = 'Waktu Kerja Melebihi';
                    }

                    const totalWorktimeMs = now - checkInTime;
                    const totalWorktime = formatDuration(totalWorktimeMs);

                    let totalOvertime = '00:00:00';
                    const overtimeThreshold = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 17, 30, 0);
                    if (now > overtimeThreshold) {
                        const overtimeMs = now - overtimeThreshold;
                        totalOvertime = formatDuration(overtimeMs);
                    }

                    // Update local state for immediate UI feedback
                    appState.attendanceData['absenPulang'] = now;
                    appState.attendanceData['locationPulang'] = location;
                    appState.attendanceData['statusPulang'] = statusPulang;
                    appState.attendanceData['totalWorktime'] = totalWorktime;
                    appState.attendanceData['totalOvertime'] = totalOvertime;
                    appState.attendanceData['remarkPekerjaan'] = document.getElementById('work-remark').value;
                    appState.attendanceData['fotoPekerjaan'] = photoDataUrl;
                    appState.attendanceData['statusAbsen'] = 'Pulang';

                    // Prepare data for spreadsheet (using original keys)
                    const dataForSheet = {
                        email: appState.loggedInUser.email,
                        absenMasuk: appState.attendanceData['Absen Masuk'],
                        absenPulang: now,
                        locationPulang: location,
                        statusPulang: statusPulang,
                        totalWorktime: totalWorktime,
                        totalOvertime: totalOvertime,
                        remarkPekerjaan: document.getElementById('work-remark').value,
                        statusAbsen: 'Pulang',
                    };
                    
                    await sendDataToSpreadsheet(dataForSheet);
                    renderUI();
                    showModal("Absen pulang berhasil!");

                } catch (error) {
                    showModal(error.message || 'Terjadi kesalahan tidak diketahui.');
                } finally {
                    checkOutBtn.disabled = false;
                    checkOutBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg> Absen Pulang';
                }
            }


            resetBtn.addEventListener('click', () => {
                appState.attendanceData = null;
                renderUI();
            });
            
            historyBtn.addEventListener('click', async () => {
                showModal("Mengambil riwayat...");
                const result = await fetchFromSpreadsheet('getHistory', appState.loggedInUser.email);
                modal.classList.add('hidden');

                const historyContainer = document.getElementById('history-container');
                historyContainer.innerHTML = '';

                if (result && result.status === 'success' && result.data.length > 0) {
                    result.data.forEach(rec => {
                        const card = document.createElement('div');
                        card.className = 'bg-slate-800/50 p-4 rounded-lg';
                        const checkInTime = new Date(rec['Absen Masuk']).toLocaleTimeString('id-ID');
                        const checkOutTime = rec['Absen Pulang'] ? new Date(rec['Absen Pulang']).toLocaleTimeString('id-ID') : 'Belum Absen';
                        
                        card.innerHTML = `
                            <p class="font-bold text-lg">${new Date(rec['Tanggal Masuk']).toLocaleDateString('id-ID')}</p>
                            <div class="text-sm text-slate-300 mt-2">
                                <p><span class="font-semibold">Masuk:</span> ${checkInTime} (${rec['Status Masuk']})</p>
                                <p><span class="font-semibold">Pulang:</span> ${checkOutTime} (${rec['Status Pulang'] || ''})</p>
                            </div>
                        `;
                        historyContainer.appendChild(card);
                    });
                } else {
                    historyContainer.innerHTML = '<p class="text-center text-slate-400">Tidak ada riwayat absensi.</p>';
                }

                checkInSection.classList.add('hidden');
                historySection.classList.remove('hidden');
            });

            backToMainBtn.addEventListener('click', () => {
                renderUI();
            });
            
            // Camera Functions
            async function startCamera() {
                try {
                    currentStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
                    videoStream.srcObject = currentStream;
                } catch (err) {
                    console.error("Error accessing camera: ", err);
                    showModal("Tidak bisa mengakses kamera. Pastikan Anda memberikan izin.");
                    cameraModal.classList.add('hidden');
                }
            }

            function stopCamera() {
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }
                cameraModal.classList.add('hidden');
            }
            
            cancelCameraBtn.addEventListener('click', stopCamera);
            
            captureBtn.addEventListener('click', async () => {
                canvas.width = videoStream.videoWidth;
                canvas.height = videoStream.videoHeight;
                canvas.getContext('2d').drawImage(videoStream, 0, 0);
                const photoDataUrl = canvas.toDataURL('image/jpeg', 0.8);
                stopCamera();
                
                if (appState.attendanceData && !appState.attendanceData['Absen Pulang']) {
                    // This is a check-out photo
                    await processCheckOut(photoDataUrl);
                } else {
                    // This is a check-in photo
                    await processCheckIn(photoDataUrl);
                }
            });


            // --- INITIALIZATION ---
            setInterval(updateDateTime, 1000);
            renderUI();
        });
    </script>
</body>
</html>
